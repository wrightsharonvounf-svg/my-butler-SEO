---
import PostLayout from '../../layouts/PostLayout.astro';
import { getCollection } from 'astro:content';

// Получаем все статьи
const posts = await getCollection('posts');

// Сортируем по дате (новые сверху)
const sortedPosts = posts.sort(
  (a, b) => new Date(b.data.pubDate) - new Date(a.data.pubDate)
);

// Static paths
export async function getStaticPaths() {
  return sortedPosts.map(post => ({
    params: { slug: post.slug },
    props: { post }
  }));
}

const { post } = Astro.props;
const { Content } = await post.render();

// Индекс текущей статьи
const currentIndex = sortedPosts.findIndex(p => p.slug === post.slug);

// Предыдущая и следующая
const prevPost = sortedPosts[currentIndex + 1];
const nextPost = sortedPosts[currentIndex - 1];
---

<PostLayout content={post.data}>
  <article>
    <Content />
  </article>

  <!-- Навигация по датам -->
  <nav style="margin-top: 3rem; padding-top: 2rem; border-top: 1px solid #eee;">
    {prevPost && (
      <div>
        ← <a href={`/blog/${prevPost.slug}/`}>
          {prevPost.data.title}
        </a>
      </div>
    )}

    {nextPost && (
      <div style="margin-top: 1rem;">
        <a href={`/blog/${nextPost.slug}/`}>
          {nextPost.data.title}
        </a> →
      </div>
    )}
  </nav>

  <!-- Блок похожих статей -->
  <section style="margin-top: 3rem;">
    <h3>Похожие статьи</h3>
    <ul>
      {sortedPosts
        .filter(p => p.slug !== post.slug)
        .slice(0, 4)
        .map(p => (
          <li>
            <a href={`/blog/${p.slug}/`}>
              {p.data.title}
            </a>
          </li>
      ))}
    </ul>
  </section>

</PostLayout>