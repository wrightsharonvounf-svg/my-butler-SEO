---
import PostLayout from '../../layouts/PostLayout.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const posts = await getCollection('posts');
  const paths = [];

  for (const post of posts) {
    const originalSlug = post.slug;
    const cleanSlug = originalSlug.replace(/-\d{4}-\d{2}-\d{2}$/, '');

    // Новая версия (без даты)
    paths.push({
      params: { slug: cleanSlug },
      props: {
        post,
        isRedirect: false,
      },
    });

    // Старая версия (с датой) — создаём redirect страницу
    if (originalSlug !== cleanSlug) {
      paths.push({
        params: { slug: originalSlug },
        props: {
          post,
          isRedirect: true,
          cleanSlug,
        },
      });
    }
  }

  return paths;
}

const { post, isRedirect, cleanSlug } = Astro.props;

// Если это redirect — контент не рендерим
let Content = null;
if (!isRedirect) {
  const rendered = await post.render();
  Content = rendered.Content;
}
---

{isRedirect ? (
  <html lang="ru">
    <head>
      <meta charset="UTF-8" />
      <meta http-equiv="refresh" content={`0; url=/blog/${cleanSlug}/`} />
      <link rel="canonical" href={`/blog/${cleanSlug}/`} />
      <title>Перенаправление...</title>
    </head>
    <body>
      <p>Страница переехала. <a href={`/blog/${cleanSlug}/`}>Перейти</a></p>
    </body>
  </html>
) : (
  <PostLayout content={post.data}>
    <article>
      <Content />
    </article>
  </PostLayout>
)}