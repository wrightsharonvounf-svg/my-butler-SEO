---
import PostLayout from '../../../layouts/PostLayout.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const posts = await getCollection('posts');

  return posts
    .filter(post => post.data.category)
    .map(post => ({
      params: {
        category: post.data.category,
        slug: post.slug,
      },
      props: post,
    }));
}

const post = Astro.props;
const { Content } = await post.render();

const { category, slug } = Astro.params;

// Получаем статьи той же категории
const allPosts = await getCollection('posts');
const relatedPosts = allPosts
  .filter(p => p.data.category === category && p.slug !== slug)
  .slice(0, 4);
---

<PostLayout content={post.data}>

  <!-- Хлебные крошки -->
  <nav style="font-size: 0.9rem; margin-bottom: 1rem;">
    <a href="/">Главная</a> →
    <a href="/blog/">Блог</a> →
    <a href={`/blog/${category}/`}>{category}</a> →
    <span>{post.data.title}</span>
  </nav>

  <article>
    <h1>{post.data.title}</h1>
    <Content />
  </article>

  {relatedPosts.length > 0 && (
    <section style="margin-top: 3rem; padding-top: 2rem; border-top: 1px solid #eee;">
      <h3>Другие статьи по теме</h3>
      <ul>
        {relatedPosts.map(p => (
          <li>
            <a href={`/blog/${category}/${p.slug}/`}>
              {p.data.title}
            </a>
          </li>
        ))}
      </ul>
    </section>
  )}

</PostLayout>
